<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinancePedro - Gest√£o Completa</title>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --bg: #f1f5f9; --card: #ffffff; --text: #1e293b;
            --text-light: #64748b; --border: #e2e8f0;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }

        /* Layout Responsivo */
        .container { max-width: 1100px; margin: 0 auto; padding: 15px; }
        
        /* Header & Nav */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .month-selector { display: flex; align-items: center; background: var(--card); padding: 8px; border-radius: var(--radius); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* Cards de Resumo */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: var(--card); padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: relative; }
        .card h3 { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 10px; }
        .card .value { font-size: 1.6rem; font-weight: 800; }
        .trend { font-size: 0.75rem; margin-top: 5px; display: flex; align-items: center; gap: 4px; }

        /* Main Content Grid */
        .main-layout { display: grid; grid-template-columns: 1fr 340px; gap: 20px; }
        @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }

        /* Gr√°ficos */
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        @media (max-width: 600px) { .charts-section { grid-template-columns: 1fr; } }
        canvas { width: 100% !important; height: 200px !important; }

        /* Filtros */
        .filters { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-chip { padding: 6px 15px; background: #e2e8f0; border-radius: 20px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; border: none; }
        .filter-chip.active { background: var(--primary); color: white; }

        /* Listas */
        .list-container { max-height: 500px; overflow-y: auto; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); transition: 0.2s; }
        .item:hover { background: #f8fafc; }
        .status-pill { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #eee; }
        .paid { background: #dcfce7; color: #166534; }

        /* Or√ßamentos */
        .budget-bar { height: 6px; background: #eee; border-radius: 3px; margin: 8px 0; overflow: hidden; }
        .budget-fill { height: 100%; transition: width 0.3s; }

        /* UI Elements */
        .btn { padding: 12px 20px; border-radius: var(--radius); border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-icon { width: 35px; height: 35px; padding: 0; border-radius: 50%; }

        /* Modais */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 20px; position: relative; }
        .modal.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; margin-bottom: 5px; color: var(--text-light); }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; }

        .positive { color: var(--success); }
        .negative { color: var(--danger); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 style="font-size: 1.5rem; letter-spacing: -1px;">Finance<span style="color:var(--primary)">Pedro</span></h1>
            <p id="dateInfo" style="font-size: 0.8rem; color: var(--text-light)"></p>
        </div>
        <div class="month-selector">
            <button class="btn btn-icon" onclick="changeMonth(-1)">‚ùÆ</button>
            <strong id="currentMonthLabel" style="min-width: 130px; text-align: center;">Dezembro 2025</strong>
            <button class="btn btn-icon" onclick="changeMonth(1)">‚ùØ</button>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="openModal('transactionModal')">+ Novo</button>
            <button class="btn btn-icon" style="background: white; border: 1px solid var(--border)" onclick="openModal('categoryModal')">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="summary-grid">
        <div class="card">
            <h3>Saldo Atual</h3>
            <div class="value" id="balanceVal">R$ 0,00</div>
            <div id="balanceTrend" class="trend"></div>
        </div>
        <div class="card">
            <h3>Receitas</h3>
            <div class="value positive" id="incomeVal">R$ 0,00</div>
            <div id="incomeTrend" class="trend"></div>
        </div>
        <div class="card">
            <h3>Despesas</h3>
            <div class="value negative" id="expenseVal">R$ 0,00</div>
            <div id="expenseTrend" class="trend"></div>
        </div>
    </div>

    <div class="main-layout">
        <div class="left-col">
            <div class="charts-section">
                <div class="card">
                    <h3>Gastos por Categoria</h3>
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="card">
                    <h3>Receita vs Despesa</h3>
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="filters" id="categoryFilters">
                    <button class="filter-chip active" onclick="setFilter('all')">Todos</button>
                </div>
                <div class="list-container" id="transactionList">
                    <!-- JS -->
                </div>
            </div>
        </div>

        <div class="right-col">
            <div class="card" style="margin-bottom: 20px;">
                <h3>Metas e Or√ßamentos</h3>
                <div id="budgetDisplay"></div>
            </div>
            
            <div class="card">
                <h3>Recorr√™ncias do M√™s</h3>
                <div id="fixedList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Transa√ß√£o -->
<div class="modal-overlay" id="transactionModal">
    <div class="modal">
        <h2 style="margin-bottom: 20px;">Cadastrar Transa√ß√£o</h2>
        <form id="tForm">
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <input type="text" id="tDesc" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" id="tAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="tType">
                        <option value="expense">Despesa</option>
                        <option value="income">Receita</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="tCat"></select>
            </div>
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="tDate" required>
            </div>
            <div style="display: flex; gap: 20px; margin: 15px 0;">
                <label style="display: inline-flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="tFixed" style="width: auto;"> Despesa Fixa
                </label>
                <label style="display: inline-flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="tPaid" style="width: auto;" checked> Pago/Recebido
                </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn" style="flex:1; background:#eee" onclick="closeModals()">Cancelar</button>
                <button type="submit" class="btn btn-primary" style="flex:1">Salvar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Categorias -->
<div class="modal-overlay" id="categoryModal">
    <div class="modal">
        <h2>Gerenciar Categorias</h2>
        <form id="cForm" style="margin-top: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee">
            <div style="display: grid; grid-template-columns: 1fr 80px; gap: 10px;">
                <input type="text" id="cName" placeholder="Nome da Categoria" required>
                <input type="color" id="cColor" value="#6366f1">
            </div>
            <input type="number" id="cLimit" placeholder="Meta de Gasto (R$)" style="margin-top: 10px;">
            <button type="submit" class="btn btn-primary" style="width:100%; margin-top: 10px;">Adicionar Categoria</button>
        </form>
        <div id="catList" style="margin-top: 15px; max-height: 200px; overflow-y: auto;"></div>
        <button class="btn" style="width:100%; margin-top: 15px; background: #eee" onclick="closeModals()">Fechar</button>
    </div>
</div>

<script>
    // --- DATABASE & STATE ---
    let db = {
        transactions: JSON.parse(localStorage.getItem('fpro_t')) || [],
        categories: JSON.parse(localStorage.getItem('fpro_c')) || [
            { name: 'Alimenta√ß√£o', color: '#ef4444', limit: 800 },
            { name: 'Sal√°rio', color: '#10b981', limit: 0 },
            { name: 'Lazer', color: '#f59e0b', limit: 300 },
            { name: 'Transporte', color: '#3b82f6', limit: 400 }
        ]
    };

    let viewDate = new Date();
    let currentFilter = 'all';

    // --- INITIALIZATION ---
    function init() {
        processRecurrences();
        render();
        setupEvents();
    }

    function save() {
        localStorage.setItem('fpro_t', JSON.stringify(db.transactions));
        localStorage.setItem('fpro_c', JSON.stringify(db.categories));
        render();
    }

    // Processa automaticamente despesas fixas para o m√™s atual se elas n√£o existirem
    function processRecurrences() {
        const m = viewDate.getMonth();
        const y = viewDate.getFullYear();
        
        const fixedTemplates = db.transactions.filter(t => t.fixed);
        fixedTemplates.forEach(temp => {
            const exists = db.transactions.find(t => 
                t.desc === temp.desc && 
                new Date(t.date).getMonth() === m && 
                new Date(t.date).getFullYear() === y
            );

            if (!exists) {
                const newT = { ...temp, id: Date.now() + Math.random(), date: new Date(y, m, new Date(temp.date).getDate()).toISOString().split('T')[0], paid: false };
                db.transactions.push(newT);
            }
        });
    }

    // --- UI RENDERING ---
    function render() {
        const m = viewDate.getMonth();
        const y = viewDate.getFullYear();
        
        // Month Label
        const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        document.getElementById('currentMonthLabel').innerText = `${months[m]} ${y}`;

        // Data Filtering
        const currentData = db.transactions.filter(t => {
            const d = new Date(t.date);
            return d.getMonth() === m && d.getFullYear() === y;
        });

        const filtered = currentFilter === 'all' ? currentData : currentData.filter(t => t.category === currentFilter);

        // Totals & Comparison
        updateSummary(currentData, m, y);
        renderTransactionList(filtered);
        renderBudgets(currentData);
        renderCategoryManagement();
        updateCategorySelects();
        
        // Charts
        drawCharts(currentData);
    }

    function updateSummary(currentData, m, y) {
        const getTotals = (data) => ({
            inc: data.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0),
            exp: data.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0)
        });

        const now = getTotals(currentData);
        
        // Dados M√™s Anterior
        const lastM = db.transactions.filter(t => {
            const d = new Date(t.date);
            return d.getMonth() === (m === 0 ? 11 : m - 1) && d.getFullYear() === (m === 0 ? y - 1 : y);
        });
        const prev = getTotals(lastM);

        document.getElementById('incomeVal').innerText = fmt(now.inc);
        document.getElementById('expenseVal').innerText = fmt(now.exp);
        document.getElementById('balanceVal').innerText = fmt(now.inc - now.exp);

        const calcTrend = (n, p) => {
            if (p === 0) return '';
            const diff = ((n - p) / p * 100).toFixed(0);
            return `<span class="${diff > 0 ? 'positive' : 'negative'}">${diff > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(diff)}% vs m√™s ant.</span>`;
        };

        document.getElementById('incomeTrend').innerHTML = calcTrend(now.inc, prev.inc);
        document.getElementById('expenseTrend').innerHTML = calcTrend(now.exp, prev.exp);
    }

    function renderTransactionList(list) {
        const container = document.getElementById('transactionList');
        container.innerHTML = list.length ? '' : '<p style="padding:20px; text-align:center; color:#999">Nenhuma transa√ß√£o encontrada.</p>';
        
        list.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
            const cat = db.categories.find(c => c.name === t.category);
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <div style="display:flex; gap:12px; align-items:center">
                    <div style="width:10px; height:10px; border-radius:50%; background:${cat?.color || '#ccc'}"></div>
                    <div>
                        <div style="font-weight:600">${t.desc} ${t.fixed ? 'üîÑ' : ''}</div>
                        <div style="font-size:0.75rem; color:#999">${t.category} ‚Ä¢ ${t.date.split('-').reverse().join('/')}</div>
                    </div>
                </div>
                <div style="text-align:right">
                    <div class="value ${t.type === 'income' ? 'positive' : 'negative'}" style="font-size:1rem">
                        ${t.type === 'income' ? '+' : '-'} ${fmt(t.amount)}
                    </div>
                    <span class="status-pill ${t.paid ? 'paid' : ''}" onclick="togglePaid(${t.id})" style="cursor:pointer">
                        ${t.paid ? 'Confirmado' : 'Pendente'}
                    </span>
                    <button onclick="deleteT(${t.id})" style="border:none; background:none; cursor:pointer; margin-left:8px">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function renderBudgets(data) {
        const container = document.getElementById('budgetDisplay');
        container.innerHTML = '';
        
        db.categories.filter(c => c.limit > 0).forEach(c => {
            const spent = data.filter(t => t.category === c.name && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const perc = Math.min((spent / c.limit) * 100, 100);
            container.innerHTML += `
                <div style="margin-bottom:15px">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem">
                        <span>${c.name}</span>
                        <span style="font-weight:bold">${perc.toFixed(0)}%</span>
                    </div>
                    <div class="budget-bar"><div class="budget-fill" style="width:${perc}%; background:${perc > 90 ? 'var(--danger)' : c.color}"></div></div>
                    <div style="font-size:0.7rem; color:#999">${fmt(spent)} de ${fmt(c.limit)}</div>
                </div>
            `;
        });
    }

    // --- CHART ENGINE (CANVAS) ---
    function drawCharts(data) {
        // Pie Chart
        const pieCanvas = document.getElementById('pieChart');
        const pCtx = pieCanvas.getContext('2d');
        const expenses = data.filter(t => t.type === 'expense');
        const catMap = {};
        expenses.forEach(e => catMap[e.category] = (catMap[e.category] || 0) + e.amount);
        
        pCtx.clearRect(0,0,400,400);
        let lastAngle = 0;
        Object.entries(catMap).forEach(([name, val]) => {
            const color = db.categories.find(c => c.name === name)?.color || '#ddd';
            const slice = (val / expenses.reduce((s,e)=>s+e.amount,0)) * 2 * Math.PI;
            pCtx.fillStyle = color;
            pCtx.beginPath();
            pCtx.moveTo(150, 100);
            pCtx.arc(150, 100, 80, lastAngle, lastAngle + slice);
            pCtx.fill();
            lastAngle += slice;
        });

        // Simple Bar Chart (Inc vs Exp)
        const barCanvas = document.getElementById('barChart');
        const bCtx = barCanvas.getContext('2d');
        const inc = data.filter(t => t.type === 'income').reduce((s,t)=>s+t.amount,0);
        const exp = data.filter(t => t.type === 'expense').reduce((s,t)=>s+t.amount,0);
        const max = Math.max(inc, exp, 1);

        bCtx.clearRect(0,0,400,400);
        bCtx.fillStyle = '#10b981';
        bCtx.fillRect(50, 180 - (inc/max*150), 40, (inc/max*150));
        bCtx.fillStyle = '#ef4444';
        bCtx.fillRect(110, 180 - (exp/max*150), 40, (exp/max*150));
    }

    // --- EVENTS & ACTIONS ---
    function setupEvents() {
        document.getElementById('tForm').onsubmit = (e) => {
            e.preventDefault();
            const t = {
                id: Date.now(),
                desc: document.getElementById('tDesc').value,
                amount: parseFloat(document.getElementById('tAmount').value),
                type: document.getElementById('tType').value,
                category: document.getElementById('tCat').value,
                date: document.getElementById('tDate').value,
                fixed: document.getElementById('tFixed').checked,
                paid: document.getElementById('tPaid').checked
            };
            db.transactions.push(t);
            save();
            closeModals();
            e.target.reset();
        };

        document.getElementById('cForm').onsubmit = (e) => {
            e.preventDefault();
            db.categories.push({
                name: document.getElementById('cName').value,
                color: document.getElementById('cColor').value,
                limit: parseFloat(document.getElementById('cLimit').value) || 0
            });
            save();
            e.target.reset();
        };
    }

    function changeMonth(step) {
        viewDate.setMonth(viewDate.getMonth() + step);
        render();
    }

    function deleteT(id) {
        db.transactions = db.transactions.filter(t => t.id !== id);
        save();
    }

    function togglePaid(id) {
        const t = db.transactions.find(t => t.id === id);
        if(t) t.paid = !t.paid;
        save();
    }

    function setFilter(cat) {
        currentFilter = cat;
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        render();
    }

    // --- HELPERS ---
    function fmt(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); }
    
    function openModal(id) { 
        document.getElementById(id).style.display = 'flex'; 
        if(id === 'transactionModal') document.getElementById('tDate').valueAsDate = new Date();
    }
    
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }

    function updateCategorySelects() {
        const html = db.categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        document.getElementById('tCat').innerHTML = html;
        
        const filterCont = document.getElementById('categoryFilters');
        filterCont.innerHTML = `<button class="filter-chip ${currentFilter === 'all' ? 'active' : ''}" onclick="setFilter('all')">Todos</button>`;
        db.categories.forEach(c => {
            filterCont.innerHTML += `<button class="filter-chip ${currentFilter === c.name ? 'active' : ''}" onclick="setFilter('${c.name}')">${c.name}</button>`;
        });
    }

    function renderCategoryManagement() {
        const cont = document.getElementById('catList');
        cont.innerHTML = db.categories.map((c, i) => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f8fafc; margin-bottom:5px; border-radius:8px">
                <span style="display:flex; align-items:center; gap:8px">
                    <div style="width:12px; height:12px; border-radius:50%; background:${c.color}"></div>
                    ${c.name}
                </span>
                <button onclick="deleteCat(${i})" style="border:none; cursor:pointer">‚úï</button>
            </div>
        `).join('');
    }

    function deleteCat(index) {
        db.categories.splice(index, 1);
        save();
    }

    // In√≠cio
    init();
</script>

</body>
</html>